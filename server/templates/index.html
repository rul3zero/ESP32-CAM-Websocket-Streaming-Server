<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Video Surveillance</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .control-btn {
            padding: 15px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .control-btn:hover {
            background-color: #0056b3;
        }
        .control-btn:active {
            background-color: #004085;
        }
        .status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-stream {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 10px;
        }
        .device-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .no-devices {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        .refresh-btn {
            background-color: #28a745;
            margin-left: 10px;
        }
        .refresh-btn:hover {
            background-color: #218838;
        }
        .server-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• ESP32-CAM Video Surveillance</h1>
            <p>Real-time WebSocket Video Streaming</p>
        </div>

        <div class="status">
            <h3>üìä Server Status</h3>
            <div class="server-info">
                <strong>Server IP:</strong> {{ server_ip }}<br>
                <strong>WebSocket URL:</strong> ws://{{ server_ip }}:3000/ws<br>
                <strong>Connected Devices:</strong> <span id="deviceCount">{{ len(deviceIds) }}</span>
            </div>
            <button class="control-btn refresh-btn" onclick="refreshStatus()">üîÑ Refresh Status</button>
        </div>

        <div class="controls">
            <h3>üéÆ Device Controls</h3>
            <div class="button-grid">
                <button class="control-btn" id="upButton">‚¨ÜÔ∏è Up</button>
                <button class="control-btn" id="downButton">‚¨áÔ∏è Down</button>
                <button class="control-btn" id="leftButton">‚¨ÖÔ∏è Left</button>
                <button class="control-btn" id="rightButton">‚û°Ô∏è Right</button>
                <button class="control-btn" id="extraButton1">üîç Zoom In</button>
                <button class="control-btn" id="extraButton2">üîç Zoom Out</button>
                <button class="control-btn" id="extraButton3">üí° Light On</button>
                <button class="control-btn" id="extraButton4">üí° Light Off</button>
            </div>
            <div id="commandStatus"></div>
        </div>

        <div class="video-container">
            <h3>üìπ Live Video Streams</h3>
            {% if deviceIds %}
                {% for deviceId in deviceIds %}
                <div class="device-info">
                    <h4>üì± Device: {{ deviceId }}</h4>
                    <img class="video-stream" 
                         src="{{ url }}{{ deviceId }}" 
                         alt="Live stream from {{ deviceId }}"
                         onerror="this.style.display='none'; showError('{{ deviceId }}');"
                         onload="this.style.display='block'; hideError('{{ deviceId }}');">
                    <div id="error-{{ deviceId }}" style="display:none;" class="no-devices">
                        ‚ùå Failed to load stream from {{ deviceId }}
                    </div>
                </div>
                {% end %}
            {% else %}
                <div class="no-devices">
                    <h4>‚ö†Ô∏è No devices connected</h4>
                    <p>Make sure your ESP32-CAM is:</p>
                    <ul style="text-align: left; display: inline-block;">
                        <li>Connected to WiFi network "smarthaus"</li>
                        <li>Running the updated firmware</li>
                        <li>Able to reach this server at {{ server_ip }}:3000</li>
                    </ul>
                    <button class="control-btn refresh-btn" onclick="location.reload()">üîÑ Refresh Page</button>
                </div>
            {% end %}
        </div>
    </div>

    <script>
        // Command sending function
        function sendButtonData(data) {
            fetch('/button', {
                method: 'POST',
                body: 'data=' + encodeURIComponent(data),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                const status = document.getElementById('commandStatus');
                status.innerHTML = `<div style="color: green; padding: 10px;">‚úÖ Command sent: ${data.message}</div>`;
                setTimeout(() => status.innerHTML = '', 3000);
            })
            .catch(error => {
                const status = document.getElementById('commandStatus');
                status.innerHTML = `<div style="color: red; padding: 10px;">‚ùå Error: ${error}</div>`;
                setTimeout(() => status.innerHTML = '', 3000);
            });
        }

        // Status refresh function
        function refreshStatus() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('deviceCount').textContent = data.connected_devices;
                console.log('Server status:', data);
            })
            .catch(error => console.error('Error fetching status:', error));
        }

        // Error handling for images
        function showError(deviceId) {
            document.getElementById('error-' + deviceId).style.display = 'block';
        }

        function hideError(deviceId) {
            document.getElementById('error-' + deviceId).style.display = 'none';
        }

        // Button event listeners
        document.getElementById("upButton").addEventListener("click", () => sendButtonData("UP"));
        document.getElementById("downButton").addEventListener("click", () => sendButtonData("DOWN"));
        document.getElementById("leftButton").addEventListener("click", () => sendButtonData("LEFT"));
        document.getElementById("rightButton").addEventListener("click", () => sendButtonData("RIGHT"));
        document.getElementById("extraButton1").addEventListener("click", () => sendButtonData("ZOOM_IN"));
        document.getElementById("extraButton2").addEventListener("click", () => sendButtonData("ZOOM_OUT"));
        document.getElementById("extraButton3").addEventListener("click", () => sendButtonData("LIGHT_ON"));
        document.getElementById("extraButton4").addEventListener("click", () => sendButtonData("LIGHT_OFF"));

        // Auto-refresh status every 30 seconds
        setInterval(refreshStatus, 30000);

        // Initial status load
        refreshStatus();
    </script>
</body>
</html>
